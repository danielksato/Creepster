var express = require('express');
var bodyParser = require('body-parser');
var cookieParser = require('cookie-parser');
var sky = require('./app/sky_api.js');
var db = require('./app/sql_interface.js');
var app = express();

//var users = [{"username":"Daniel","url":"http://i.imgur.com/pEM8lMf.jpg","photoData":{"status":"success","photos":[{"url":"http://i.imgur.com/pEM8lMf.jpg","pid":"F@0b72107f7d8b66d508acc24e45671ec5_3b1da96c9fb2a","width":1080,"height":1920,"tags":[]}],"usage":{"used":6,"remaining":94,"limit":100,"reset_time":1450137322,"reset_time_text":"Mon, 14 December 2015 23:55:22 +0000"},"operation_id":"262fce39469445a1be697169c6e14580"}},{"username":"Another Daniel","url":"http://i.imgur.com/v35WvfQ.jpg","photoData":{"status":"success","photos":[{"url":"http://i.imgur.com/v35WvfQ.jpg","pid":"F@0490e81549887d8546f8e0d87d519093_10fccae6de96c","width":1213,"height":909,"tags":[{"uids":[],"label":null,"confirmed":false,"manual":false,"width":3.87,"height":5.17,"yaw":21,"roll":-18,"pitch":0,"attributes":{"face":{"value":"true","confidence":59},"gender":{"value":"male","confidence":32},"glasses":{"value":"false","confidence":89},"dark_glasses":{"value":"false","confidence":76},"smiling":{"value":"true","confidence":31},"age_est":{"value":"15","confidence":50},"mood":{"value":"sad","confidence":66},"eyes":{"value":"closed","confidence":11},"neutral_mood":{"value":"false","confidence":0},"anger":{"value":"false","confidence":5},"disgust":{"value":"false","confidence":3},"fear":{"value":"false","confidence":0},"happiness":{"value":"false","confidence":33},"sadness":{"value":"true","confidence":66},"surprise":{"value":"false","confidence":28}},"points":null,"similarities":null,"tid":"TEMP_F@0490e81549887d8546f8e0d8001b0080_10fccae6de96c_02.23_14.08_0_1","recognizable":true,"center":{"x":2.23,"y":14.08},"eye_left":{"x":2.64,"y":12.65,"confidence":57,"id":449},"eye_right":{"x":0.74,"y":13.42,"confidence":35,"id":450},"mouth_center":{"x":1.81,"y":16.28,"confidence":55,"id":615},"nose":{"x":1.81,"y":15.07,"confidence":53,"id":403}},{"uids":[],"label":null,"confirmed":false,"manual":false,"width":4.04,"height":5.39,"yaw":5,"roll":-25,"pitch":0,"attributes":{"face":{"value":"true","confidence":64},"gender":{"value":"female","confidence":34},"glasses":{"value":"false","confidence":57},"dark_glasses":{"value":"false","confidence":53},"smiling":{"value":"true","confidence":71},"age_est":{"value":"12","confidence":50},"mood":{"value":"sad","confidence":43},"lips":{"value":"parted","confidence":48},"neutral_mood":{"value":"false","confidence":0},"anger":{"value":"false","confidence":28},"disgust":{"value":"false","confidence":31},"fear":{"value":"false","confidence":5},"happiness":{"value":"false","confidence":32},"sadness":{"value":"false","confidence":43},"surprise":{"value":"false","confidence":36}},"points":null,"similarities":null,"tid":"TEMP_F@0490e81549887d8546f8e0d800a10066_10fccae6de96c_13.27_11.22_0_1","recognizable":true,"center":{"x":13.27,"y":11.22},"eye_left":{"x":13.85,"y":9.57,"confidence":57,"id":449},"eye_right":{"x":11.87,"y":10.89,"confidence":53,"id":450},"mouth_center":{"x":13.11,"y":13.09,"confidence":52,"id":615},"nose":{"x":13.11,"y":12.1,"confidence":53,"id":403}},{"uids":[],"label":null,"confirmed":false,"manual":false,"width":16.24,"height":21.67,"yaw":-25,"roll":1,"pitch":0,"attributes":{"face":{"value":"true","confidence":64},"gender":{"value":"male","confidence":3},"glasses":{"value":"false","confidence":69},"dark_glasses":{"value":"false","confidence":66},"smiling":{"value":"true","confidence":69},"age_est":{"value":"13","confidence":50},"mood":{"value":"sad","confidence":62},"lips":{"value":"parted","confidence":90},"neutral_mood":{"value":"false","confidence":0},"anger":{"value":"false","confidence":0},"disgust":{"value":"true","confidence":52},"fear":{"value":"false","confidence":0},"happiness":{"value":"false","confidence":14},"sadness":{"value":"true","confidence":62},"surprise":{"value":"false","confidence":43}},"points":null,"similarities":null,"tid":"TEMP_F@0490e81549887d8546f8e0d8024601b8_10fccae6de96c_47.98_48.40_0_1","recognizable":true,"center":{"x":47.98,"y":48.4},"eye_left":{"x":53.92,"y":43.45,"confidence":56,"id":449},"eye_right":{"x":46.66,"y":43.23,"confidence":55,"id":450},"mouth_center":{"x":50.12,"y":56.11,"confidence":37,"id":615},"nose":{"x":50.54,"y":48.51,"confidence":56,"id":403}},{"uids":[],"label":null,"confirmed":false,"manual":false,"width":3.63,"height":4.84,"yaw":23,"roll":-11,"pitch":0,"attributes":{"face":{"value":"true","confidence":61},"gender":{"value":"male","confidence":22},"glasses":{"value":"false","confidence":11},"dark_glasses":{"value":"false","confidence":55},"smiling":{"value":"true","confidence":23},"age_est":{"value":"16","confidence":50},"mood":{"value":"disgusted","confidence":79},"lips":{"value":"parted","confidence":83},"eyes":{"value":"open","confidence":28},"neutral_mood":{"value":"false","confidence":0},"anger":{"value":"false","confidence":0},"disgust":{"value":"true","confidence":79},"fear":{"value":"false","confidence":0},"happiness":{"value":"false","confidence":0},"sadness":{"value":"false","confidence":23},"surprise":{"value":"true","confidence":64}},"points":null,"similarities":null,"tid":"TEMP_F@0490e81549887d8546f8e0d80264001a_10fccae6de96c_50.45_02.86_0_1","recognizable":true,"center":{"x":50.45,"y":2.86},"eye_left":{"x":50.7,"y":1.54,"confidence":56,"id":449},"eye_right":{"x":48.89,"y":2.09,"confidence":52,"id":450},"mouth_center":{"x":49.96,"y":4.29,"confidence":51,"id":615},"nose":{"x":49.96,"y":3.3,"confidence":53,"id":403}},{"uids":[],"label":null,"confirmed":false,"manual":false,"width":4.7,"height":6.27,"yaw":-8,"roll":16,"pitch":0,"attributes":{"face":{"value":"true","confidence":67},"gender":{"value":"female","confidence":23},"glasses":{"value":"true","confidence":100},"smiling":{"value":"true","confidence":10},"age_est":{"value":"12","confidence":50},"mood":{"value":"disgusted","confidence":75},"lips":{"value":"parted","confidence":91},"eyes":{"value":"open","confidence":47},"neutral_mood":{"value":"false","confidence":4},"anger":{"value":"false","confidence":9},"disgust":{"value":"true","confidence":75},"fear":{"value":"false","confidence":3},"happiness":{"value":"false","confidence":3},"sadness":{"value":"false","confidence":0},"surprise":{"value":"false","confidence":17}},"points":null,"similarities":null,"tid":"TEMP_F@0490e81549887d8546f8e0d802c2003c_10fccae6de96c_58.20_06.60_0_1","recognizable":true,"center":{"x":58.2,"y":6.6},"eye_left":{"x":60.02,"y":5.83,"confidence":55,"id":449},"eye_right":{"x":57.38,"y":4.84,"confidence":55,"id":450},"mouth_center":{"x":58.04,"y":7.92,"confidence":22,"id":615},"nose":{"x":58.53,"y":7.59,"confidence":56,"id":403}},{"uids":[],"label":null,"confirmed":false,"manual":false,"width":3.05,"height":4.07,"yaw":5,"roll":12,"pitch":0,"attributes":{"face":{"value":"true","confidence":68},"gender":{"value":"female","confidence":10},"glasses":{"value":"false","confidence":57},"dark_glasses":{"value":"false","confidence":55},"age_est":{"value":"16","confidence":50},"mood":{"value":"surprised","confidence":69},"eyes":{"value":"open","confidence":16},"neutral_mood":{"value":"false","confidence":0},"anger":{"value":"false","confidence":0},"disgust":{"value":"false","confidence":0},"fear":{"value":"false","confidence":0},"happiness":{"value":"false","confidence":29},"sadness":{"value":"false","confidence":30},"surprise":{"value":"true","confidence":69}},"points":null,"similarities":null,"tid":"TEMP_F@0490e81549887d8546f8e0d8037f0024_10fccae6de96c_73.78_03.96_0_1","recognizable":true,"center":{"x":73.78,"y":3.96},"eye_left":{"x":74.86,"y":3.41,"confidence":52,"id":449},"eye_right":{"x":73.21,"y":2.97,"confidence":57,"id":450},"mouth_center":{"x":73.78,"y":5.5,"confidence":29,"id":615},"nose":{"x":73.78,"y":4.4,"confidence":54,"id":403}},{"uids":[],"label":null,"confirmed":false,"manual":false,"width":4.7,"height":6.27,"yaw":4,"roll":30,"pitch":0,"attributes":{"face":{"value":"true","confidence":61},"gender":{"value":"female","confidence":4},"glasses":{"value":"false","confidence":61},"dark_glasses":{"value":"false","confidence":48},"smiling":{"value":"true","confidence":100},"age_est":{"value":"7","confidence":50},"mood":{"value":"happy","confidence":49},"lips":{"value":"parted","confidence":30},"neutral_mood":{"value":"false","confidence":0},"anger":{"value":"false","confidence":23},"disgust":{"value":"false","confidence":33},"fear":{"value":"false","confidence":0},"happiness":{"value":"false","confidence":49},"sadness":{"value":"false","confidence":12},"surprise":{"value":"false","confidence":22}},"points":null,"similarities":null,"tid":"TEMP_F@0490e81549887d8546f8e0d803e400b7_10fccae6de96c_82.11_20.13_0_1","recognizable":true,"center":{"x":82.11,"y":20.13},"eye_left":{"x":83.51,"y":19.8,"confidence":56,"id":449},"eye_right":{"x":81.29,"y":18.15,"confidence":52,"id":450},"mouth_center":{"x":81.53,"y":22.22,"confidence":53,"id":615},"nose":{"x":81.86,"y":21.01,"confidence":55,"id":403}}]}],"usage":{"used":1,"remaining":99,"limit":100,"reset_time":1450137322,"reset_time_text":"Mon, 14 December 2015 23:55:22 +0000"},"operation_id":"d269b896b7ab468cb83b6300f8e1b458"}},{"username":"Yet Another","url":"http://i.imgur.com/o69TIti.png","photoData":{"status":"success","photos":[{"url":"http://i.imgur.com/o69TIti.png","pid":"F@0009978d6f54854d0119c8f7181cc612_a90d6b7b15840","width":421,"height":723,"tags":[{"uids":[],"label":null,"confirmed":false,"manual":false,"width":54.39,"height":31.67,"yaw":32,"roll":-32,"pitch":0,"attributes":{"face":{"value":"true","confidence":72},"gender":{"value":"male","confidence":72},"glasses":{"value":"false","confidence":74},"dark_glasses":{"value":"false","confidence":56},"smiling":{"value":"true","confidence":99},"age_est":{"value":"17","confidence":50},"mood":{"value":"happy","confidence":80},"lips":{"value":"parted","confidence":45},"eyes":{"value":"open","confidence":58},"neutral_mood":{"value":"false","confidence":36},"anger":{"value":"false","confidence":8},"disgust":{"value":"false","confidence":0},"fear":{"value":"false","confidence":0},"happiness":{"value":"true","confidence":80},"sadness":{"value":"false","confidence":42},"surprise":{"value":"false","confidence":25}},"points":null,"similarities":null,"tid":"TEMP_F@0009978d6f54854d0119c8f700d3014c_a90d6b7b15840_50.12_45.92_0_1","recognizable":true,"center":{"x":50.12,"y":45.92},"eye_left":{"x":46.32,"y":37.48,"confidence":58,"id":449},"eye_right":{"x":23.75,"y":45.92,"confidence":55,"id":450},"mouth_center":{"x":48.69,"y":58.23,"confidence":54,"id":615},"nose":{"x":39.9,"y":52.42,"confidence":55,"id":403}}]}],"usage":{"used":2,"remaining":98,"limit":100,"reset_time":1450137322,"reset_time_text":"Mon, 14 December 2015 23:55:22 +0000"},"operation_id":"fcd0b04e25b04a5f92372392987b6241"}},{"username":"Loren","url":"http://i.imgur.com/AHezcXs.jpg","photoData":{"status":"success","photos":[{"url":"http://i.imgur.com/AHezcXs.jpg","pid":"F@0393341636d866195e72ec3c7b68b6e0_f432d8b7f1956","width":1920,"height":2560,"tags":[{"uids":[],"label":null,"confirmed":false,"manual":false,"width":10.57,"height":7.93,"yaw":-32,"roll":-34,"pitch":0,"attributes":{"face":{"value":"true","confidence":72},"gender":{"value":"female","confidence":67},"glasses":{"value":"false","confidence":42},"dark_glasses":{"value":"false","confidence":49},"smiling":{"value":"true","confidence":100},"age_est":{"value":"14","confidence":50},"mood":{"value":"happy","confidence":50},"lips":{"value":"parted","confidence":67},"eyes":{"value":"open","confidence":70},"neutral_mood":{"value":"false","confidence":0},"anger":{"value":"false","confidence":33},"disgust":{"value":"false","confidence":0},"fear":{"value":"false","confidence":0},"happiness":{"value":"true","confidence":50},"sadness":{"value":"false","confidence":9},"surprise":{"value":"false","confidence":40}},"points":null,"similarities":null,"tid":"TEMP_F@0393341636d866195e72ec3c036a0413_f432d8b7f1956_45.52_40.74_0_1","recognizable":true,"center":{"x":45.52,"y":40.74},"eye_left":{"x":47.92,"y":37.3,"confidence":57,"id":449},"eye_right":{"x":43.49,"y":39.53,"confidence":57,"id":450},"mouth_center":{"x":48.44,"y":42.42,"confidence":25,"id":615},"nose":{"x":48.02,"y":39.77,"confidence":52,"id":403}}]}],"usage":{"used":3,"remaining":97,"limit":100,"reset_time":1450137322,"reset_time_text":"Mon, 14 December 2015 23:55:22 +0000"},"operation_id":"30b4e95981984364b6ce2e5a67458b81"}}];
//var users = [];
//console.log('users: '+users.length);
app.post('/',bodyParser.urlencoded(),function(req,res){
  sky.detect(req.body.url,function(data){
    var photoData = JSON.parse(data);
    if (photoData.photos.length){
      if (photoData.photos[0].tags.length){
        var gender = null;
        if (photoData.photos[0].tags[0].attributes.gender.confidence > 50){
          gender = photoData.photos[0].tags[0].attributes.gender.value;
        }
      }
    }
    db.addUser({
                username: req.body.username,
                url: req.body.url,
                gender: gender,
                likes: gender ? 0 : -1
              },function(){
      res.status(201);
      res.set({'Set-Cookie':'creepster_user='+req.body.username})
      res.sendFile(__dirname+'/index.html');
    });
  });
});

app.get('/users',function(req,res){
  db.getAll(function(rows){
    res.set('Content-Type','application/json');
    res.status(200);
    res.send(JSON.stringify(rows));
  });
});

app.post('/likes',cookieParser(),bodyParser.urlencoded(),function(req,res){
  //if (req.cookies.creepster_user){
    //console.log(req.body);
    like = {
      fromUser : req.body.fromUser,//req.cookies.creepster_user,
      toUser : req.body.toUser,
      value : req.body.value
    }
    db.addLike(like,function(){
      res.status(201);
      res.send('Like Received');
    });
  // } else {
  //   res.status(401);
  //   res.send('Log in with a picture');
  // }
});


app.use(express.static('.'));
app.listen(3000);
